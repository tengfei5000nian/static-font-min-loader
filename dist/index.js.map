{"version":3,"file":"index.js","names":["loaderName","getExt","fromRes","resourcePath","match","fromKey","toRes","resourceQuery","toKey","from","to","getQuery","query","Object","assign","links","replace","include","exclude","filter","text","SchemaUtils","validate","options","getText","paths","keys","findFiles","fs","rootContext","Array","isArray","texts","Promise","all","map","path","addDependency","callbackAsync","call","encoding","t","join","name","args","resolve","reject","err","result","ignoreDot","ignoreDir","ignoreEmptyDir","ignoreUnreadableDir","ignoreChildren","ignoreFile","pathFilter","bind","fileList","stat","isDirectory","files","state","length","includes","file","filePath","Path","code","raw","content","meta","callback","async","ext","key","fontmin","Fontmin","src","use","glyph","otf2ttf","clone","svg2ttf","svgs2ttf","ttf2eot","ttf2svg","ttf2woff","ttf2woff2","Error","resource","data","_contents","filename","relative","_compilation","hooks","assetPath","tap","assetInfo","RegExp"],"sources":["../src/index.js"],"sourcesContent":["import Path from 'path'\nimport Fontmin from 'fontmin'\nimport SchemaUtils from 'schema-utils'\n\nimport options from './options.json'\n\nconst loaderName = 'font-loader'\n\nfunction getExt() {\n  const fromRes = this.resourcePath.match(/\\.([\\w\\d]+)$/)\n  const fromKey = fromRes && fromRes[1]\n\n  const toRes = this.resourceQuery.match(/to\\=([\\w\\d]+)/)\n  const toKey = toRes && toRes[1]\n\n  return {\n    from: fromKey,\n    to: toKey || fromKey\n  }\n}\n\nfunction getQuery() {\n  const query = Object.assign({\n    links: this.resourcePath.replace(/\\.([\\w\\d]+)$/, '.txt'),\n    include: null,\n    exclude: null,\n    filter: text => text\n  }, this.query)\n\n  SchemaUtils.validate(options, query)\n\n  return query\n}\n\nasync function getText(query) {\n  const paths = query.include || query.exclude\n    ? Object.keys(await findFiles(this.fs, this.rootContext, { include: query.include, exclude: query.exclude }))\n    : (Array.isArray(query.links) ? query.links : [query.links])\n  const texts = await Promise.all(\n    paths.map(async path => {\n      this.addDependency(path)\n      return callbackAsync.call(this.fs, 'readFile', path, {\n        encoding: 'utf8'\n      })\n    })\n  )\n  const text = texts.map(([t]) => t).join('')\n  return text\n}\n\nasync function callbackAsync(name, ...args) {\n  return new Promise((resolve, reject) => {\n    this[name](...args, (err, ...result) => {\n      err ? reject(err) : resolve(result)\n    })\n  })\n}\n\nasync function findFiles(fs, path, options) {\n  options = Object.assign({\n    include: null,\n    exclude: null,\n    ignoreDot: true,\n    ignoreDir: true,\n    ignoreEmptyDir: true,\n    ignoreUnreadableDir: true,\n    ignoreChildren: false,\n    ignoreFile: false\n  }, options)\n  options.filter = (options.filter || pathFilter).bind(options)\n\n  const fileList = {}\n\n  try {\n    const [stat] = await callbackAsync.call(fs, 'stat', path)\n\n    if (stat.isDirectory()) {\n      const [files] = await callbackAsync.call(fs, 'readdir', path)\n      const state = options.filter(path, stat, !!files.length)\n\n      if ([0, 3].includes(state)) fileList[path] = stat\n\n      if ([0, 2].includes(state)) await Promise.all(\n        files.map(async file => {\n          const filePath = Path.join(path, file)\n          Object.assign(fileList, await findFiles(fs, filePath, options))\n        })\n      )\n    } else if (options.filter(path, stat, false) === 0) {\n      fileList[path] = stat\n    }\n  } catch (err) {\n    if (err.code === 'EACCES' && options.ignoreUnreadableDir) return fileList\n    throw err\n  }\n\n  return fileList\n}\n\nexport const raw = true\n\nexport default async function (content, map, meta) {\n  const callback = this.async()\n  try {\n    const query = getQuery.call(this)\n    const text = await getText.call(this, query)\n\n    const ext = getExt.call(this)\n    const key = `${ext.from}2${ext.to}`\n    const fontmin = new Fontmin()\n    fontmin.src(content)\n\n    fontmin.use(\n      Fontmin.glyph({\n        text: query.filter(text)\n      })\n    )\n\n    switch (key) {\n      case 'otf2otf':\n      case 'ttf2ttf':\n      case 'svg2svg':\n      case 'svgs2svgs':\n      case 'eot2eot':\n      case 'woff2woff':\n      case 'woff22woff2':\n        break;\n      case 'otf2ttf':\n        fontmin.use(Fontmin.otf2ttf({\n          clone: true\n        }))\n        break;\n      case 'svg2ttf':\n        fontmin.use(Fontmin.svg2ttf({\n          clone: true\n        }))\n        break;\n      case 'svgs2ttf':\n        fontmin.use(Fontmin.svgs2ttf({\n          clone: true\n        }))\n        break;\n      case 'ttf2eot':\n        fontmin.use(Fontmin.ttf2eot({\n          clone: true\n        }))\n        break;\n      case 'ttf2svg':\n        fontmin.use(Fontmin.ttf2svg({\n          clone: true\n        }))\n        break;\n      case 'ttf2woff':\n        fontmin.use(Fontmin.ttf2woff({\n          clone: true\n        }))\n        break;\n      case 'ttf2woff2':\n        fontmin.use(Fontmin.ttf2woff2({\n          clone: true\n        }))\n        break;\n      default:\n        throw new Error(`无法进行转换：${this.resource}`)\n    }\n\n    const [files] = await callbackAsync.call(fontmin, 'run')\n    const file = files[files.length - 1]\n    const data = file._contents\n\n    const filename = Path.relative(this.rootContext, this.resource)\n\n    this._compilation.hooks.assetPath.tap(loaderName, (path, data, assetInfo) => {\n      if (data.filename !== filename) return\n      return path.replace(new RegExp(`\\\\.${ext.from}$`), `.${ext.to}`)\n    });\n\n    callback(null, data, map, meta)\n  } catch (err) {\n    callback(err, '', map, meta)\n  }\n}\n"],"mappings":"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"}